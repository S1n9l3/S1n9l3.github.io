

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/Aries.ico">
  <link rel="icon" href="/img/Aries.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="YY">
  <meta name="keywords" content="">
  
    <meta name="description" content="PE结构PE结构是一种固定的文件狗屎，通常写在二进制文件的最开始部分。 PE文件主要分为三部分：  DOS头 NT头 文件头 可选头   节头  在VS中，通过下面的代码查看： 1234#include &lt;windows.h&gt;_IMAGE_DOS_HEADER;_IMAGE_NT_HEADERS;_IMAGE_SECTION_HEADER;    基础WORD类型 占4个位置,2字节">
<meta property="og:type" content="article">
<meta property="og:title" content="[代码分析] PE结构">
<meta property="og:url" content="https://s1n9l3.github.io/2023/03/06/[%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90]%20PE%E7%BB%93%E6%9E%84/index.html">
<meta property="og:site_name" content="S1n9l3">
<meta property="og:description" content="PE结构PE结构是一种固定的文件狗屎，通常写在二进制文件的最开始部分。 PE文件主要分为三部分：  DOS头 NT头 文件头 可选头   节头  在VS中，通过下面的代码查看： 1234#include &lt;windows.h&gt;_IMAGE_DOS_HEADER;_IMAGE_NT_HEADERS;_IMAGE_SECTION_HEADER;    基础WORD类型 占4个位置,2字节">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230306210246584.png">
<meta property="og:image" content="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230306210800195.png">
<meta property="og:image" content="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230306211206778.png">
<meta property="og:image" content="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230306211333537.png">
<meta property="og:image" content="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230306212034488.png">
<meta property="og:image" content="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230306212119389.png">
<meta property="og:image" content="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230306212410911.png">
<meta property="og:image" content="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230306213113698.png">
<meta property="og:image" content="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230306213245194.png">
<meta property="og:image" content="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230308201820453.png">
<meta property="og:image" content="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230308204115727.png">
<meta property="og:image" content="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230308204149785.png">
<meta property="og:image" content="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230308204320472.png">
<meta property="og:image" content="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230308204359554.png">
<meta property="og:image" content="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230308204432844.png">
<meta property="og:image" content="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230308204522134.png">
<meta property="og:image" content="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230308204550754.png">
<meta property="og:image" content="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230308205546721.png">
<meta property="og:image" content="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230308205703526.png">
<meta property="og:image" content="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230308210216199.png">
<meta property="og:image" content="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230308211545095.png">
<meta property="article:published_time" content="2023-03-06T12:51:08.082Z">
<meta property="article:modified_time" content="2023-03-08T13:17:59.664Z">
<meta property="article:author" content="YY">
<meta property="article:tag" content="PE">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230306210246584.png">
  
  
  
  <title>[代码分析] PE结构 - S1n9l3</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"s1n9l3.github.io","root":"/","version":"1.9.3","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>WXYY</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/post.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="[代码分析] PE结构"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-03-06 20:51" pubdate>
          2023年3月6日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          10k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          85 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">[代码分析] PE结构</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="PE结构"><a href="#PE结构" class="headerlink" title="PE结构"></a>PE结构</h1><p>PE结构是一种固定的文件狗屎，通常写在二进制文件的最开始部分。</p>
<p>PE文件主要分为三部分：</p>
<ul>
<li>DOS头</li>
<li>NT头<ul>
<li>文件头</li>
<li>可选头</li>
</ul>
</li>
<li>节头</li>
</ul>
<p>在VS中，通过下面的代码查看：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;windows.h&gt;</span></span><br>_IMAGE_DOS_HEADER;<br>_IMAGE_NT_HEADERS;<br>_IMAGE_SECTION_HEADER;<br></code></pre></td></tr></table></figure>



<h2 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h2><p><strong>WORD类型 占4个位置,2字节</strong></p>
<p><strong>DOWRD类型 占8个位置，4个字节</strong></p>
<p><strong>BYTE类型 占2个位置，1个字节</strong></p>
<p><img src="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230306210246584.png" srcset="/img/loading.gif" lazyload alt="image-20230306210246584"></p>
<p>在上图中，一对数字表示一个字节。</p>
<p>关于数字的读法，上面<code>4D 5A</code>是一个<code>WORD</code>，读法是<code>5A4D</code>，即一组从右向左，一字节从左向右。</p>
<h2 id="DOS头"><a href="#DOS头" class="headerlink" title="DOS头"></a>DOS头</h2><p>对于现在的程序，DOS头中大部分都不起作用了，</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_DOS_HEADER</span> &#123;</span>      <span class="hljs-comment">// DOS .EXE header</span><br>    WORD   e_magic;                     <span class="hljs-comment">// Magic number</span><br>    WORD   e_cblp;                      <span class="hljs-comment">// Bytes on last page of file</span><br>    WORD   e_cp;                        <span class="hljs-comment">// Pages in file</span><br>    WORD   e_crlc;                      <span class="hljs-comment">// Relocations</span><br>    WORD   e_cparhdr;                   <span class="hljs-comment">// Size of header in paragraphs</span><br>    WORD   e_minalloc;                  <span class="hljs-comment">// Minimum extra paragraphs needed</span><br>    WORD   e_maxalloc;                  <span class="hljs-comment">// Maximum extra paragraphs needed</span><br>    WORD   e_ss;                        <span class="hljs-comment">// Initial (relative) SS value</span><br>    WORD   e_sp;                        <span class="hljs-comment">// Initial SP value</span><br>    WORD   e_csum;                      <span class="hljs-comment">// Checksum</span><br>    WORD   e_ip;                        <span class="hljs-comment">// Initial IP value</span><br>    WORD   e_cs;                        <span class="hljs-comment">// Initial (relative) CS value</span><br>    WORD   e_lfarlc;                    <span class="hljs-comment">// File address of relocation table</span><br>    WORD   e_ovno;                      <span class="hljs-comment">// Overlay number</span><br>    WORD   e_res[<span class="hljs-number">4</span>];                    <span class="hljs-comment">// Reserved words</span><br>    WORD   e_oemid;                     <span class="hljs-comment">// OEM identifier (for e_oeminfo)</span><br>    WORD   e_oeminfo;                   <span class="hljs-comment">// OEM information; e_oemid specific</span><br>    WORD   e_res2[<span class="hljs-number">10</span>];                  <span class="hljs-comment">// Reserved words</span><br>    LONG   e_lfanew;                    <span class="hljs-comment">// File address of new exe header</span><br>  &#125; IMAGE_DOS_HEADER, *PIMAGE_DOS_HEADER;<br></code></pre></td></tr></table></figure>

<p>主要需记住<code>WORD e_magic</code>，是<code>Magic number</code>，值是<code>5A4D</code>，字符是<code>MZ</code>；</p>
<p><img src="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230306210800195.png" srcset="/img/loading.gif" lazyload alt="image-20230306210800195"></p>
<p>然后是<code>LONG   e_lfanew</code>，<code>LONG</code>占4字节，偏移位置，一般接下来就是文件签名。</p>
<p><img src="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230306211206778.png" srcset="/img/loading.gif" lazyload alt="image-20230306211206778"></p>
<h2 id="NT头"><a href="#NT头" class="headerlink" title="NT头"></a>NT头</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_NT_HEADERS</span> &#123;</span><br>    DWORD Signature;<br>    IMAGE_FILE_HEADER FileHeader;<br>    IMAGE_OPTIONAL_HEADER32 OptionalHeader;<br>&#125; IMAGE_NT_HEADERS32, *PIMAGE_NT_HEADERS32;<br></code></pre></td></tr></table></figure>

<p>首先是<code>DWORD Signature</code>，字符为<code>PE..</code>，表示开始；</p>
<p><img src="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230306211333537.png" srcset="/img/loading.gif" lazyload alt="image-20230306211333537"></p>
<p>然后进入文件头。</p>
<h3 id="文件头"><a href="#文件头" class="headerlink" title="文件头"></a>文件头</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_FILE_HEADER</span> &#123;</span><br>    WORD    Machine;<br>    WORD    NumberOfSections;<br>    DWORD   TimeDateStamp;<br>    DWORD   PointerToSymbolTable;<br>    DWORD   NumberOfSymbols;<br>    WORD    SizeOfOptionalHeader;<br>    WORD    Characteristics;<br>&#125; IMAGE_FILE_HEADER, *PIMAGE_FILE_HEADER;<br></code></pre></td></tr></table></figure>

<h4 id="WORD-Machine"><a href="#WORD-Machine" class="headerlink" title="WORD Machine"></a>WORD Machine</h4><p><code>WORD    Machine</code>，表示程序可以运行在什么CPU上，这里是<code>014C</code>，表示<code>Intel386</code>架构的芯片；</p>
<p><img src="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230306212034488.png" srcset="/img/loading.gif" lazyload alt="image-20230306212034488"></p>
<p>对应为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_MACHINE_UNKNOWN           0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_MACHINE_TARGET_HOST       0x0001  <span class="hljs-comment">// Useful for indicating we want to interact with the host and not a WoW guest.</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_MACHINE_I386              0x014c  <span class="hljs-comment">// Intel 386.</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_MACHINE_R3000             0x0162  <span class="hljs-comment">// MIPS little-endian, 0x160 big-endian</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_MACHINE_R4000             0x0166  <span class="hljs-comment">// MIPS little-endian</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_MACHINE_R10000            0x0168  <span class="hljs-comment">// MIPS little-endian</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_MACHINE_WCEMIPSV2         0x0169  <span class="hljs-comment">// MIPS little-endian WCE v2</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_MACHINE_ALPHA             0x0184  <span class="hljs-comment">// Alpha_AXP</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_MACHINE_SH3               0x01a2  <span class="hljs-comment">// SH3 little-endian</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_MACHINE_SH3DSP            0x01a3</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_MACHINE_SH3E              0x01a4  <span class="hljs-comment">// SH3E little-endian</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_MACHINE_SH4               0x01a6  <span class="hljs-comment">// SH4 little-endian</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_MACHINE_SH5               0x01a8  <span class="hljs-comment">// SH5</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_MACHINE_ARM               0x01c0  <span class="hljs-comment">// ARM Little-Endian</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_MACHINE_THUMB             0x01c2  <span class="hljs-comment">// ARM Thumb/Thumb-2 Little-Endian</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_MACHINE_ARMNT             0x01c4  <span class="hljs-comment">// ARM Thumb-2 Little-Endian</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_MACHINE_AM33              0x01d3</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_MACHINE_POWERPC           0x01F0  <span class="hljs-comment">// IBM PowerPC Little-Endian</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_MACHINE_POWERPCFP         0x01f1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_MACHINE_IA64              0x0200  <span class="hljs-comment">// Intel 64</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_MACHINE_MIPS16            0x0266  <span class="hljs-comment">// MIPS</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_MACHINE_ALPHA64           0x0284  <span class="hljs-comment">// ALPHA64</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_MACHINE_MIPSFPU           0x0366  <span class="hljs-comment">// MIPS</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_MACHINE_MIPSFPU16         0x0466  <span class="hljs-comment">// MIPS</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_MACHINE_AXP64             IMAGE_FILE_MACHINE_ALPHA64</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_MACHINE_TRICORE           0x0520  <span class="hljs-comment">// Infineon</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_MACHINE_CEF               0x0CEF</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_MACHINE_EBC               0x0EBC  <span class="hljs-comment">// EFI Byte Code</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_MACHINE_AMD64             0x8664  <span class="hljs-comment">// AMD64 (K8)</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_MACHINE_M32R              0x9041  <span class="hljs-comment">// M32R little-endian</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_MACHINE_ARM64             0xAA64  <span class="hljs-comment">// ARM64 Little-Endian</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_MACHINE_CEE               0xC0EE</span><br></code></pre></td></tr></table></figure>

<h4 id="WORD-NumberOfSections"><a href="#WORD-NumberOfSections" class="headerlink" title="WORD NumberOfSections"></a>WORD NumberOfSections</h4><p><code>WORD    NumberOfSections</code>表示程序有多少区节段，这里是<code>0008</code>，表示有8个区节段；</p>
<p><img src="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230306212119389.png" srcset="/img/loading.gif" lazyload alt="image-20230306212119389"></p>
<p>区节段包括：</p>
<ul>
<li><code>.text</code>，表示代码</li>
<li><code>.data</code>，表示变量</li>
<li><code>.tls</code>，表示线程共同使用的代码</li>
<li><code>.reloc</code>，表示重定位</li>
<li><code>.rsrc</code>，表示资源，图标、视频、音频</li>
</ul>
<h4 id="DWORD-TimeDateStamp"><a href="#DWORD-TimeDateStamp" class="headerlink" title="DWORD TimeDateStamp"></a>DWORD TimeDateStamp</h4><p><code>DWORD TimeDateStamp</code>，时间戳，表示创建时间，UTC标准，</p>
<p><img src="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230306212410911.png" srcset="/img/loading.gif" lazyload alt="image-20230306212410911"></p>
<p>这里<code>63FB579C</code>，转换为十进制是<code>1677416348</code>，表示<code>2023-2-26 20:59:8</code>；</p>
<h4 id="DWORD-PointerToSymbolTable"><a href="#DWORD-PointerToSymbolTable" class="headerlink" title="DWORD PointerToSymbolTable"></a>DWORD PointerToSymbolTable</h4><p><code>DWORD PointerToSymbolTable</code>，表示表指针，已被废弃。</p>
<h4 id="DWORD-NumberOfSymbols"><a href="#DWORD-NumberOfSymbols" class="headerlink" title="DWORD NumberOfSymbols"></a>DWORD NumberOfSymbols</h4><p><code>DWORD NumberOfSymbols</code>，表示表数量，已被废弃。</p>
<h4 id="WORD-SizeOfOptionalHeader"><a href="#WORD-SizeOfOptionalHeader" class="headerlink" title="WORD SizeOfOptionalHeader"></a>WORD SizeOfOptionalHeader</h4><p><code>WORD SizeOfOptionalHeader</code>，可选头大小，表示32位还是64为文件，</p>
<ul>
<li>32位文件是<code>224</code>，即十六进制<code>E0</code>；</li>
<li>64位文件是<code>240</code>，即十六进制<code>F0</code>；</li>
</ul>
<p><img src="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230306213113698.png" srcset="/img/loading.gif" lazyload alt="image-20230306213113698"></p>
<h4 id="WORD-Characteristics"><a href="#WORD-Characteristics" class="headerlink" title="WORD Characteristics"></a>WORD Characteristics</h4><p><code>WORD Characteristics</code>，文件特征，</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_RELOCS_STRIPPED           0x0001  <span class="hljs-comment">// Relocation info stripped from file.</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_EXECUTABLE_IMAGE          0x0002  <span class="hljs-comment">// File is executable  (i.e. no unresolved external references).</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_LINE_NUMS_STRIPPED        0x0004  <span class="hljs-comment">// Line nunbers stripped from file.</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_LOCAL_SYMS_STRIPPED       0x0008  <span class="hljs-comment">// Local symbols stripped from file.</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_AGGRESIVE_WS_TRIM         0x0010  <span class="hljs-comment">// Aggressively trim working set</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_LARGE_ADDRESS_AWARE       0x0020  <span class="hljs-comment">// App can handle &gt;2gb addresses</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_BYTES_REVERSED_LO         0x0080  <span class="hljs-comment">// Bytes of machine word are reversed.</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_32BIT_MACHINE             0x0100  <span class="hljs-comment">// 32 bit word machine.</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_DEBUG_STRIPPED            0x0200  <span class="hljs-comment">// Debugging info stripped from file in .DBG file</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_REMOVABLE_RUN_FROM_SWAP   0x0400  <span class="hljs-comment">// If Image is on removable media, copy and run from the swap file.</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_NET_RUN_FROM_SWAP         0x0800  <span class="hljs-comment">// If Image is on Net, copy and run from the swap file.</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_SYSTEM                    0x1000  <span class="hljs-comment">// System File.</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_DLL                       0x2000  <span class="hljs-comment">// File is a DLL.</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_UP_SYSTEM_ONLY            0x4000  <span class="hljs-comment">// File should only be run on a UP machine</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_FILE_BYTES_REVERSED_HI         0x8000  <span class="hljs-comment">// Bytes of machine word are reversed.</span></span><br></code></pre></td></tr></table></figure>

<p>比如这里是<code>0103</code>，是下面的组合：</p>
<ul>
<li><code>IMAGE_FILE_32BIT_MACHINE</code>，表示<code>0x0100</code>，32位的机器；</li>
<li><code>IMAGE_FILE_EXECUTABLE_IMAGE</code>，表示<code>0x0002</code>，文件可执行；</li>
<li><code>IMAGE_FILE_RELOCS_STRIPPED</code>，表示<code>0x0001</code>，从文件中删除了重新定位信息；</li>
</ul>
<p><img src="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230306213245194.png" srcset="/img/loading.gif" lazyload alt="image-20230306213245194"></p>
<h3 id="可选NT头"><a href="#可选NT头" class="headerlink" title="可选NT头"></a>可选NT头</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_OPTIONAL_HEADER</span> &#123;</span><br>    <span class="hljs-comment">//</span><br>    <span class="hljs-comment">// Standard fields.</span><br>    <span class="hljs-comment">//</span><br><br>    WORD    Magic;<br>    BYTE    MajorLinkerVersion;<br>    BYTE    MinorLinkerVersion;<br>    DWORD   SizeOfCode;<br>    DWORD   SizeOfInitializedData;<br>    DWORD   SizeOfUninitializedData;<br>    DWORD   AddressOfEntryPoint;<br>    DWORD   BaseOfCode;<br>    DWORD   BaseOfData;<br><br>    <span class="hljs-comment">//</span><br>    <span class="hljs-comment">// NT additional fields.</span><br>    <span class="hljs-comment">//</span><br><br>    DWORD   ImageBase;<br>    DWORD   SectionAlignment;<br>    DWORD   FileAlignment;<br>    WORD    MajorOperatingSystemVersion;<br>    WORD    MinorOperatingSystemVersion;<br>    WORD    MajorImageVersion;<br>    WORD    MinorImageVersion;<br>    WORD    MajorSubsystemVersion;<br>    WORD    MinorSubsystemVersion;<br>    DWORD   Win32VersionValue;<br>    DWORD   SizeOfImage;<br>    DWORD   SizeOfHeaders;<br>    DWORD   CheckSum;<br>    WORD    Subsystem;<br>    WORD    DllCharacteristics;<br>    DWORD   SizeOfStackReserve;<br>    DWORD   SizeOfStackCommit;<br>    DWORD   SizeOfHeapReserve;<br>    DWORD   SizeOfHeapCommit;<br>    DWORD   LoaderFlags;<br>    DWORD   NumberOfRvaAndSizes;<br>    IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES];<br>&#125; IMAGE_OPTIONAL_HEADER32, *PIMAGE_OPTIONAL_HEADER32;<br><br></code></pre></td></tr></table></figure>

<h4 id="WORD-Magic"><a href="#WORD-Magic" class="headerlink" title="WORD Magic"></a><strong>WORD Magic</strong></h4><p><code>WORD Magic</code>，文件类型标识，</p>
<ul>
<li><code>0x10B</code>，表示这是一个32位镜像文件；</li>
<li><code>0x107</code>，表示这是一个ROM镜像；</li>
<li><code>0x20B</code>，表示这是一个64位镜像文件；</li>
</ul>
<p><img src="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230308201820453.png" srcset="/img/loading.gif" lazyload alt="image-20230308201820453"></p>
<h4 id="BYTE-MajorLinkerVersion"><a href="#BYTE-MajorLinkerVersion" class="headerlink" title="BYTE MajorLinkerVersion"></a>BYTE MajorLinkerVersion</h4><p><code>BYTE MajorLinkerVersion</code>，链接器的版本号。</p>
<h4 id="BYTE-MinorLinkerVersion"><a href="#BYTE-MinorLinkerVersion" class="headerlink" title="BYTE MinorLinkerVersion"></a>BYTE MinorLinkerVersion</h4><p><code>BYTE MinorLinkerVersion</code>，链接器副版本号。</p>
<h4 id="DWORD-SizeOfCode"><a href="#DWORD-SizeOfCode" class="headerlink" title="DWORD SizeOfCode"></a>DWORD SizeOfCode</h4><p><code>DWORD SizeOfCode</code>，<code>.text</code>总大小。</p>
<h4 id="DWORD-SizeOfInitializedData"><a href="#DWORD-SizeOfInitializedData" class="headerlink" title="DWORD SizeOfInitializedData"></a>DWORD SizeOfInitializedData</h4><p><code>DWORD SizeOfInitializedData</code>，<code>.data</code>总大小。</p>
<h4 id="DWORD-SizeOfUninitializedData"><a href="#DWORD-SizeOfUninitializedData" class="headerlink" title="DWORD SizeOfUninitializedData"></a>DWORD SizeOfUninitializedData</h4><p><code>DWORD SizeOfUninitializedData</code>，<code>.bss</code>总大小，BSS段通常是指用来存放程序中未初始化的或者初始化为0的全局变量和静态变量的一块内存区域。特点是可读写的，在程序执行之前BSS段会自动清0。</p>
<h4 id="DWORD-AddressOfEntryPoint"><a href="#DWORD-AddressOfEntryPoint" class="headerlink" title="DWORD AddressOfEntryPoint"></a><strong>DWORD AddressOfEntryPoint</strong></h4><p><code>DWORD AddressOfEntryPoint</code>，程序的虚拟入口地址，按照偏移量的方式表示。</p>
<p><img src="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230308204115727.png" srcset="/img/loading.gif" lazyload alt="image-20230308204115727"></p>
<p>这里是<code>11023</code>，在OD中打开，进入的第一行就是这里，</p>
<p><img src="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230308204149785.png" srcset="/img/loading.gif" lazyload alt="image-20230308204149785"></p>
<h4 id="DWORD-BaseOfCode"><a href="#DWORD-BaseOfCode" class="headerlink" title="DWORD BaseOfCode"></a>DWORD BaseOfCode</h4><p><code>DWORD BaseOfCode</code>，代码基址，表示写的代码的开始，</p>
<p><img src="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230308204320472.png" srcset="/img/loading.gif" lazyload alt="image-20230308204320472"></p>
<p>在OD中，最上面的一行，</p>
<p><img src="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230308204359554.png" srcset="/img/loading.gif" lazyload alt="image-20230308204359554"></p>
<h4 id="DWORD-BaseOfData"><a href="#DWORD-BaseOfData" class="headerlink" title="DWORD BaseOfData"></a>DWORD BaseOfData</h4><p><code>DWORD BaseOfData</code>，数据基址。</p>
<p><img src="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230308204432844.png" srcset="/img/loading.gif" lazyload alt="image-20230308204432844"></p>
<h4 id="DWORD-ImageBase"><a href="#DWORD-ImageBase" class="headerlink" title="DWORD ImageBase"></a>DWORD ImageBase</h4><p><code>DWORD ImageBase</code>，入口点，<strong>当加载进内存时镜像的第1个字节的首选地址。它必须是64K的倍数。DLL默认是10000000H。Windows CE 的EXE默认是00010000H。Windows 系列的EXE默认是00400000H。</strong></p>
<p><img src="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230308204522134.png" srcset="/img/loading.gif" lazyload alt="image-20230308204522134"></p>
<p>在OD中，格式是<code>00400000</code>，上面的地址在此基础上偏移的。</p>
<p><img src="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230308204550754.png" srcset="/img/loading.gif" lazyload alt="image-20230308204550754"></p>
<p>如果设置了<strong>随机基址</strong>，导致看到的地址会不同的。</p>
<h4 id="DWORD-SectionAlignment"><a href="#DWORD-SectionAlignment" class="headerlink" title="DWORD SectionAlignment"></a>DWORD SectionAlignment</h4><p><code>DWORD SectionAlignment</code>，当加载进内存时节的对齐值（以字节计）（内存）</p>
<h4 id="DWORD-FileAlignment"><a href="#DWORD-FileAlignment" class="headerlink" title="DWORD FileAlignment"></a>DWORD FileAlignment</h4><p><code>DWORD FileAlignment</code>，用来对齐镜像文件的节中的原始数据的对齐因子（以字节计）（磁盘）</p>
<blockquote>
<p>对齐：</p>
<p>一个pe文件无论在磁盘和内存中存放都会进行对齐，但他们的对齐值会不相同。<br>PE 文件头里边的FileAligment 定义了磁盘区块的对齐值。每一个区块从对齐值的倍数的偏移位置开始存放。而区块的实际代码或数据的大小不一定刚好是这么多，所以在多余的地方一般以00h 来填充，这就是区块间的间隙。<br>PE 文件头里边的SectionAligment 定义了内存中区块的对齐值。PE 文件被映射到内存中时，区块总是至少从一个页边界开始。</p>
</blockquote>
<h4 id="WORD-MajorOperatingSystemVersion"><a href="#WORD-MajorOperatingSystemVersion" class="headerlink" title="WORD MajorOperatingSystemVersion"></a>WORD MajorOperatingSystemVersion</h4><h4 id="WORD-MinorOperatingSystemVersion"><a href="#WORD-MinorOperatingSystemVersion" class="headerlink" title="WORD MinorOperatingSystemVersion"></a>WORD MinorOperatingSystemVersion</h4><h4 id="WORD-MajorImageVersion"><a href="#WORD-MajorImageVersion" class="headerlink" title="WORD MajorImageVersion"></a>WORD MajorImageVersion</h4><h4 id="WORD-MinorImageVersion"><a href="#WORD-MinorImageVersion" class="headerlink" title="WORD MinorImageVersion"></a>WORD MinorImageVersion</h4><h4 id="WORD-MajorSubsystemVersion"><a href="#WORD-MajorSubsystemVersion" class="headerlink" title="WORD MajorSubsystemVersion"></a>WORD MajorSubsystemVersion</h4><h4 id="WORD-MinorSubsystemVersion"><a href="#WORD-MinorSubsystemVersion" class="headerlink" title="WORD MinorSubsystemVersion"></a>WORD MinorSubsystemVersion</h4><p>以上全是版本号</p>
<h4 id="DWORD-Win32VersionValue"><a href="#DWORD-Win32VersionValue" class="headerlink" title="DWORD Win32VersionValue"></a>DWORD Win32VersionValue</h4><p>win32版本（必须为0）</p>
<h4 id="DWORD-SizeOfImage"><a href="#DWORD-SizeOfImage" class="headerlink" title="DWORD SizeOfImage"></a>DWORD SizeOfImage</h4><p>文件总大小</p>
<h4 id="DWORD-SizeOfHeaders"><a href="#DWORD-SizeOfHeaders" class="headerlink" title="DWORD SizeOfHeaders"></a>DWORD SizeOfHeaders</h4><p>三个头的总大小</p>
<h4 id="DWORD-CheckSum"><a href="#DWORD-CheckSum" class="headerlink" title="DWORD CheckSum"></a>DWORD CheckSum</h4><p>校验和（用来检查文件是否被修改）</p>
<h4 id="WORD-Subsystem"><a href="#WORD-Subsystem" class="headerlink" title="WORD Subsystem"></a>WORD Subsystem</h4><p>子系统</p>
<p>子系统表：</p>
<table>
<thead>
<tr>
<th>值</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>未知子系统</td>
</tr>
<tr>
<td>1</td>
<td>设备驱动程序和Native Windows进程</td>
</tr>
<tr>
<td>2</td>
<td>Windows图形用户界面（GUI）子系统（一般程序），通常指MFC</td>
</tr>
<tr>
<td>3</td>
<td>Windows字符模式（CUI）子系统（从命令提示符启动的）</td>
</tr>
<tr>
<td>7</td>
<td>Posix字符模式子系统</td>
</tr>
<tr>
<td>9</td>
<td>Windows CE</td>
</tr>
<tr>
<td>10</td>
<td>可扩展固件接口（EFI）应用程序</td>
</tr>
<tr>
<td>11</td>
<td>带引导服务的EFI驱动程序</td>
</tr>
<tr>
<td>12</td>
<td>带运行时服务的EFI驱动程序</td>
</tr>
<tr>
<td>13</td>
<td>EFI ROM镜像</td>
</tr>
<tr>
<td>14</td>
<td>XBOX</td>
</tr>
</tbody></table>
<p>这里是</p>
<p><img src="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230308205546721.png" srcset="/img/loading.gif" lazyload alt="image-20230308205546721"></p>
<h4 id="WORD-DllCharacteristics"><a href="#WORD-DllCharacteristics" class="headerlink" title="WORD DllCharacteristics"></a>WORD DllCharacteristics</h4><p>dll特征</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_DLLCHARACTERISTICS_DYNAMIC_BASE 0x0040     <span class="hljs-comment">// DLL can move. aslr随机地址关掉</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_DLLCHARACTERISTICS_FORCE_INTEGRITY    0x0080     <span class="hljs-comment">// Code Integrity Image</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_DLLCHARACTERISTICS_NX_COMPAT    0x0100     <span class="hljs-comment">// Image is NX compatible</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_DLLCHARACTERISTICS_NO_ISOLATION 0x0200     <span class="hljs-comment">// Image understands isolation and doesn&#x27;t want it</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_DLLCHARACTERISTICS_NO_SEH       0x0400     <span class="hljs-comment">// Image does not use SEH.  No SE handler may reside in this image</span></span><br>                                                        <span class="hljs-comment">//seh的保护机制</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_DLLCHARACTERISTICS_NO_BIND      0x0800     <span class="hljs-comment">// Do not bind this image.</span></span><br><span class="hljs-comment">//                                            0x1000     // Reserved.</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_DLLCHARACTERISTICS_WDM_DRIVER   0x2000     <span class="hljs-comment">// Driver uses WDM model</span></span><br>                                                        <span class="hljs-comment">//大部分的dll都有这个</span><br><span class="hljs-comment">//                                            0x4000     // Reserved.</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_DLLCHARACTERISTICS_TERMINAL_SERVER_AWARE     0x8000</span><br></code></pre></td></tr></table></figure>

<p>这里是<code>8100</code>，表示下面的两个特征：</p>
<ul>
<li><code>IMAGE_DLLCHARACTERISTICS_TERMINAL_SERVER_AWARE</code></li>
<li><code>IMAGE_DLLCHARACTERISTICS_NX_COMPAT</code></li>
</ul>
<p><img src="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230308205703526.png" srcset="/img/loading.gif" lazyload alt="image-20230308205703526"></p>
<h4 id="DWORD-SizeOfStackReserve"><a href="#DWORD-SizeOfStackReserve" class="headerlink" title="DWORD SizeOfStackReserve"></a>DWORD SizeOfStackReserve</h4><p>栈保留大小</p>
<h4 id="DWORD-SizeOfStackCommit"><a href="#DWORD-SizeOfStackCommit" class="headerlink" title="DWORD SizeOfStackCommit"></a>DWORD SizeOfStackCommit</h4><p>栈申请大小</p>
<h4 id="DWORD-SizeOfHeapReserve"><a href="#DWORD-SizeOfHeapReserve" class="headerlink" title="DWORD SizeOfHeapReserve"></a>DWORD SizeOfHeapReserve</h4><p>堆保留大小</p>
<h4 id="DWORD-SizeOfHeapCommit"><a href="#DWORD-SizeOfHeapCommit" class="headerlink" title="DWORD SizeOfHeapCommit"></a>DWORD SizeOfHeapCommit</h4><p>堆申请大小</p>
<h4 id="DWORD-LoaderFlags"><a href="#DWORD-LoaderFlags" class="headerlink" title="DWORD LoaderFlags"></a>DWORD LoaderFlags</h4><p>标志位（必须为0）</p>
<h4 id="DWORD-NumberOfRvaAndSizes"><a href="#DWORD-NumberOfRvaAndSizes" class="headerlink" title="DWORD NumberOfRvaAndSizes"></a>DWORD NumberOfRvaAndSizes</h4><p>数据目录（16）</p>
<h4 id="IMAGE-DATA-DIRECTORY"><a href="#IMAGE-DATA-DIRECTORY" class="headerlink" title="IMAGE_DATA_DIRECTORY"></a>IMAGE_DATA_DIRECTORY</h4><p>API函数导入表的位置，是函数位置的，</p>
<p><img src="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230308210216199.png" srcset="/img/loading.gif" lazyload alt="image-20230308210216199"></p>
<h2 id="节头"><a href="#节头" class="headerlink" title="节头"></a>节头</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_SECTION_HEADER</span> &#123;</span><br>    BYTE    Name[IMAGE_SIZEOF_SHORT_NAME];<br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>            DWORD   PhysicalAddress;<br>            DWORD   VirtualSize;<br>    &#125; Misc;<br>    DWORD   VirtualAddress;<br>    DWORD   SizeOfRawData;<br>    DWORD   PointerToRawData;<br>    DWORD   PointerToRelocations;<br>    DWORD   PointerToLinenumbers;<br>    WORD    NumberOfRelocations;<br>    WORD    NumberOfLinenumbers;<br>    DWORD   Characteristics;<br>&#125; IMAGE_SECTION_HEADER, *PIMAGE_SECTION_HEADER;<br></code></pre></td></tr></table></figure>

<ul>
<li><p><code>BYTE Name[IMAGE_SIZEOF_SHORT_NAME];</code>，本节的名字</p>
</li>
<li><p><code>DWORD PhysicalAddress;</code>，本节的物理地址</p>
</li>
<li><p><code>DWORD VirtualSize</code>，本节的实际大小</p>
<blockquote>
<p>为什么有union大括号：2选1，通常选后面，因为不知道具体的物理地址 </p>
</blockquote>
</li>
<li><p><code>DWORD VirtualAddress</code>，本节的RVA，在内存中的位置，<br>虚拟地址，指的偏移量；</p>
</li>
<li><p><code>DWORD SizeOfRawData</code>，本节在磁盘中的大小</p>
</li>
<li><p><code>DWORD PointerToRawData</code>，本节在磁盘中的偏移<br>在文件中的偏移；</p>
</li>
<li><p><code>DWORD PointerToRelocations</code>，exe文件无意义</p>
</li>
<li><p><code>DWORD PointerToLinenumbers</code>，行号表的位置（调试用，不过基本没用）</p>
</li>
<li><p><code>WORD NumberOfRelocations</code>，重定位数量</p>
</li>
<li><p><code>WORD NumberOfLinenumbers</code>，行号表数量</p>
</li>
<li><p><code>DWORD Characteristics</code>，特征</p>
</li>
</ul>
<p>特征表：</p>
<table>
<thead>
<tr>
<th>值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>IMAGE_SCN_CNT_CODE 0x00000020</td>
<td>包含代码，常与 0x10000000一起设置。</td>
</tr>
<tr>
<td>IMAGE_SCN_CNT_INITIALIZED_DATA 0x00000040</td>
<td>该区块包含已初始化的数据。</td>
</tr>
<tr>
<td>IMAGE_SCN_CNT_UNINITIALIZED_DATA 0x00000080</td>
<td>该区块包含未初始化的数据。</td>
</tr>
<tr>
<td>IMAGE_SCN_MEM_DISCARDABLE 0x02000000</td>
<td>该区块可被丢弃，因为当它一旦被装入后，进程就不在需要它了，典型的如重定位区块（如.reloc）。</td>
</tr>
<tr>
<td>IMAGE_SCN_MEM_SHARED 0x10000000</td>
<td>该区块为共享区块。</td>
</tr>
<tr>
<td>IMAGE_SCN_MEM_EXECUTE 0x20000000</td>
<td>该区块可以执行。通常当0x00000020被设置时候，该标志也被设置。</td>
</tr>
<tr>
<td>IMAGE_SCN_MEM_READ 0x40000000</td>
<td>该区块可读，可执行文件中的区块总是设置该标志。</td>
</tr>
<tr>
<td>IMAGE_SCN_MEM_WRITE 0x80000000</td>
<td>该区块可写。该标志没有设置，装载程序就会将内存映像也标记为可读或可执行</td>
</tr>
</tbody></table>
<p>比如这里的特征，<code>E00000A0</code>，表示可读可写可执行，</p>
<ul>
<li><code>IMAGE_SCN_MEM_WRITE</code>，<code>0x80000000</code></li>
<li><code>IMAGE_SCN_MEM_READ</code>，<code>0x40000000</code></li>
<li><code>IMAGE_SCN_MEM_EXECUTE</code>，<code>0x20000000</code></li>
<li><code>IMAGE_SCN_CNT_UNINITIALIZED_DATA</code>，<code>0x00000080</code></li>
<li><code>IMAGE_SCN_CNT_CODE</code>，<code>0x00000020</code></li>
</ul>
<p><img src="https://picgo-1307028727.cos.ap-chengdu.myqcloud.com/picgo/image-20230308211545095.png" srcset="/img/loading.gif" lazyload alt="image-20230308211545095"></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/" class="category-chain-item">代码分析</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/PE/">#PE</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>[代码分析] PE结构</div>
      <div>https://s1n9l3.github.io/2023/03/06/[代码分析] PE结构/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>YY</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年3月6日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/03/05/%5Bctf-reverse%5D%20rsa/" title="[ctf-reverse] rsa">
                        <span class="hidden-mobile">[ctf-reverse] rsa</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
